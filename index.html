document.addEventListener("DOMContentLoaded", function () {

  // --- Clean number biar aman format Indonesia ----
  function cleanNum(str) {
    if (!str) return 0;
    return Number(String(str)
      .replace(/\./g, "")     // 1.500.000 → 1500000
      .replace(/,/g, "")      // 1,500,000 → 1500000
      .trim()
    ) || 0;
  }

  // --- Baca CSV ---
  function loadCSV(file, callback) {
    let reader = new FileReader();
    reader.onload = function (e) {
      let text = e.target.result;
      let rows = text.split("\n").map(r => r.split(","));
      callback(rows);
    };
    reader.readAsText(file);
  }

  // --- Saat upload ---
  document.getElementById("fileCSV").addEventListener("change", function (e) {
    let file = e.target.files[0];
    loadCSV(file, buildTable);
  });

  // --- Build table ---
  function buildTable(data) {
    let tableBody = document.getElementById("tableBody");
    tableBody.innerHTML = "";

    for (let i = 1; i < data.length; i++) {   // skip header
      let row = data[i];
      if (row.length < 6) continue;          // kalau kolom kurang

      let nama = row[0];
      let code = row[1];
      let cust = row[2];

      let target = cleanNum(row[3]);
      let order = cleanNum(row[4]);
      let sales = cleanNum(row[5]);

      let orderPct = target > 0 ? ((order / target) * 100).toFixed(2) : 0;
      let salesPct = target > 0 ? ((sales / target) * 100).toFixed(2) : 0;

      let gapOrder = target - order;
      let gapSales = target - sales;

      let tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${nama}</td>
        <td>${code}</td>
        <td>${cust}</td>
        <td>${target.toLocaleString()}</td>
        <td>${order.toLocaleString()}</td>
        <td>${orderPct}%</td>
        <td>${sales.toLocaleString()}</td>
        <td>${salesPct}%</td>
        <td>${gapOrder.toLocaleString()}</td>
        <td>${gapSales.toLocaleString()}</td>
      `;
      tableBody.appendChild(tr);
    }
  }
});
